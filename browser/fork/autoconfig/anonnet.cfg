// AnonNet Browser Locked Configuration
// These settings CANNOT be changed by users
// This ensures security and privacy settings remain enforced

/******************************************************************************
 * ANONNET PROXY CONFIGURATION (LOCKED)
 ******************************************************************************/

// Discover proxy port from daemon
try {
    // Try to read port from file written by daemon
    const portFile = Components.classes["@mozilla.org/file/local;1"]
        .createInstance(Components.interfaces.nsIFile);

    // Try common locations
    const possiblePaths = [
        OS.Path.join(OS.Constants.Path.homeDir, ".anonnet", "data", "socks5_port.txt"),
        OS.Path.join(OS.Constants.Path.profileDir, "anonnet_socks5_port.txt"),
        "./data/socks5_port.txt"
    ];

    let proxyPort = 9050; // Default fallback

    for (let path of possiblePaths) {
        try {
            if (OS.File.exists(path)) {
                let portText = OS.File.read(path, { encoding: "utf-8" });
                let port = parseInt(portText.trim());
                if (port > 0 && port < 65536) {
                    proxyPort = port;
                    break;
                }
            }
        } catch (e) {
            // Try next path
        }
    }

    // Lock proxy configuration
    lockPref("network.proxy.type", 1);
    lockPref("network.proxy.socks", "127.0.0.1");
    lockPref("network.proxy.socks_port", proxyPort);
    lockPref("network.proxy.socks_version", 5);
    lockPref("network.proxy.socks_remote_dns", true);

    // Disable other proxy types
    lockPref("network.proxy.http", "");
    lockPref("network.proxy.http_port", 0);
    lockPref("network.proxy.ssl", "");
    lockPref("network.proxy.ssl_port", 0);
    lockPref("network.proxy.ftp", "");
    lockPref("network.proxy.ftp_port", 0);

    // No proxy exceptions (everything goes through AnonNet)
    lockPref("network.proxy.no_proxies_on", "");

    // Disable proxy failover (never bypass proxy)
    lockPref("network.proxy.failover_direct", false);
    lockPref("network.proxy.failover_timeout", 1800);

    // Prevent proxy changes via PAC/WPAD
    lockPref("network.proxy.autoconfig_url", "");
    lockPref("network.proxy.pac_generator", "");

} catch (e) {
    // Fallback to hardcoded port
    lockPref("network.proxy.type", 1);
    lockPref("network.proxy.socks", "127.0.0.1");
    lockPref("network.proxy.socks_port", 9050);
    lockPref("network.proxy.socks_version", 5);
    lockPref("network.proxy.socks_remote_dns", true);
}

/******************************************************************************
 * DNS & CONNECTION SECURITY (LOCKED)
 ******************************************************************************/

// Route ALL DNS through SOCKS proxy (critical for anonymity)
lockPref("network.proxy.socks_remote_dns", true);
lockPref("network.dns.disablePrefetch", true);
lockPref("network.dns.disablePrefetchFromHTTPS", true);

// Disable DNS over HTTPS (we handle DNS through proxy)
lockPref("network.trr.mode", 5); // 5 = disabled

// Disable IPv6 (potential leak vector)
lockPref("network.dns.disableIPv6", true);

// Disable speculative connections
lockPref("network.http.speculative-parallel-limit", 0);
lockPref("network.predictor.enabled", false);
lockPref("network.prefetch-next", false);

/******************************************************************************
 * PRIVACY & FINGERPRINTING RESISTANCE (LOCKED)
 ******************************************************************************/

// Resist Fingerprinting (RFP) - Tor Browser's core protection
lockPref("privacy.resistFingerprinting", true);
lockPref("privacy.resistFingerprinting.letterboxing", true);
lockPref("privacy.resistFingerprinting.block_mozAddonManager", true);

// First-party isolation
lockPref("privacy.firstparty.isolate", true);

// Tracking Protection
lockPref("privacy.trackingprotection.enabled", true);
lockPref("privacy.trackingprotection.pbmode.enabled", true);
lockPref("privacy.trackingprotection.socialtracking.enabled", true);
lockPref("privacy.trackingprotection.fingerprinting.enabled", true);
lockPref("privacy.trackingprotection.cryptomining.enabled", true);

// WebGL (fingerprinting vector)
lockPref("webgl.disabled", true);
lockPref("webgl.enable-webgl2", false);

// WebRTC (IP leak vector)
lockPref("media.peerconnection.enabled", false);
lockPref("media.peerconnection.ice.default_address_only", true);
lockPref("media.peerconnection.ice.no_host", true);
lockPref("media.peerconnection.ice.proxy_only_if_behind_proxy", true);

// Audio fingerprinting
lockPref("media.webaudio.enabled", false);

// Geolocation
lockPref("geo.enabled", false);
lockPref("geo.wifi.uri", "");

// Canvas fingerprinting
lockPref("privacy.resistFingerprinting.autoDeclineNoUserInputCanvasPrompts", false);

/******************************************************************************
 * SECURITY HARDENING (LOCKED)
 ******************************************************************************/

// HTTPS-only mode
lockPref("dom.security.https_only_mode", true);
lockPref("dom.security.https_only_mode_pbm", true);
lockPref("dom.security.https_only_mode_ever_enabled", true);

// Certificate pinning
lockPref("security.cert_pinning.enforcement_level", 2);

// OCSP stapling
lockPref("security.ssl.enable_ocsp_stapling", true);
lockPref("security.OCSP.enabled", 1);
lockPref("security.OCSP.require", true);

// Disable TLS false start
lockPref("security.ssl.enable_false_start", false);

// TLS version (minimum 1.2)
lockPref("security.tls.version.min", 3);
lockPref("security.tls.version.max", 4);

/******************************************************************************
 * DISABLE TELEMETRY & DATA COLLECTION (LOCKED)
 ******************************************************************************/

lockPref("datareporting.healthreport.uploadEnabled", false);
lockPref("datareporting.policy.dataSubmissionEnabled", false);
lockPref("toolkit.telemetry.enabled", false);
lockPref("toolkit.telemetry.unified", false);
lockPref("toolkit.telemetry.archive.enabled", false);
lockPref("toolkit.telemetry.server", "");
lockPref("toolkit.telemetry.coverage.opt-out", true);
lockPref("toolkit.coverage.opt-out", true);
lockPref("toolkit.coverage.endpoint.base", "");

// Crash reporting
lockPref("breakpad.reportURL", "");
lockPref("browser.crashReports.unsubmittedCheck.enabled", false);
lockPref("browser.crashReports.unsubmittedCheck.autoSubmit2", false);

// Studies
lockPref("app.shield.optoutstudies.enabled", false);
lockPref("app.normandy.enabled", false);
lockPref("app.normandy.api_url", "");

/******************************************************************************
 * DISABLE AUTOMATIC CONNECTIONS (LOCKED)
 ******************************************************************************/

// Updates (we handle this ourselves)
lockPref("app.update.enabled", false);
lockPref("app.update.auto", false);
lockPref("extensions.update.enabled", false);
lockPref("extensions.update.autoUpdateDefault", false);

// Safe browsing (privacy risk - sends URLs to Google)
lockPref("browser.safebrowsing.enabled", false);
lockPref("browser.safebrowsing.malware.enabled", false);
lockPref("browser.safebrowsing.phishing.enabled", false);
lockPref("browser.safebrowsing.downloads.enabled", false);

// Pocket
lockPref("extensions.pocket.enabled", false);

// Captive portal detection
lockPref("network.captive-portal-service.enabled", false);

// Connectivity checks
lockPref("network.connectivity-service.enabled", false);

/******************************************************************************
 * BROWSER BEHAVIOR (LOCKED)
 ******************************************************************************/

// User agent (standardized to reduce fingerprinting)
lockPref("general.useragent.override", "Mozilla/5.0 (Windows NT 10.0; rv:128.0) Gecko/20100101 Firefox/128.0");

// Referer policy (strict)
lockPref("network.http.referer.XOriginPolicy", 2);
lockPref("network.http.referer.XOriginTrimmingPolicy", 2);

// Service workers (potential privacy issue)
lockPref("dom.serviceWorkers.enabled", false);

// IndexedDB (fingerprinting vector)
lockPref("dom.indexedDB.enabled", false);

// Notifications
lockPref("dom.webnotifications.enabled", false);
lockPref("dom.push.enabled", false);

// Battery API (fingerprinting)
lockPref("dom.battery.enabled", false);

// Gamepad API (fingerprinting)
lockPref("dom.gamepad.enabled", false);

// Virtual Reality (fingerprinting)
lockPref("dom.vr.enabled", false);

/******************************************************************************
 * CLEAR DATA ON SHUTDOWN (LOCKED)
 ******************************************************************************/

lockPref("privacy.sanitize.sanitizeOnShutdown", true);
lockPref("privacy.clearOnShutdown.cache", true);
lockPref("privacy.clearOnShutdown.cookies", true);
lockPref("privacy.clearOnShutdown.downloads", true);
lockPref("privacy.clearOnShutdown.formdata", true);
lockPref("privacy.clearOnShutdown.history", true);
lockPref("privacy.clearOnShutdown.offlineApps", true);
lockPref("privacy.clearOnShutdown.sessions", true);
lockPref("privacy.clearOnShutdown.siteSettings", false); // Keep site perms

/******************************************************************************
 * ANONNET-SPECIFIC SETTINGS
 ******************************************************************************/

// Homepage (can be customized by user)
defaultPref("browser.startup.homepage", "about:blank");
defaultPref("browser.startup.page", 1);

// New tab page (blank)
lockPref("browser.newtabpage.enabled", false);
lockPref("browser.newtab.preload", false);

// API endpoint (users can change if running custom daemon)
defaultPref("extensions.anonnet.apiPort", 19150);

// Credit warning threshold
defaultPref("extensions.anonnet.creditWarningThreshold", 100);

// Low credit warning
defaultPref("extensions.anonnet.lowCreditWarningThreshold", 50);

/******************************************************************************
 * DEVELOPER CONSOLE ACCESS (UNLOCKED)
 ******************************************************************************/

// Allow developers to inspect browser, but lock security settings
defaultPref("devtools.debugger.remote-enabled", false);
defaultPref("devtools.chrome.enabled", true);
defaultPref("devtools.debugger.prompt-connection", true);

/******************************************************************************
 * BRANDING
 ******************************************************************************/

defaultPref("browser.aboutHomeSnippets.updateUrl", "");
defaultPref("browser.startup.homepage_override.mstone", "ignore");
defaultPref("startup.homepage_welcome_url", "");
defaultPref("startup.homepage_override_url", "");

// Display settings
lockPref("privacy.window.maxInnerWidth", 1000);
lockPref("privacy.window.maxInnerHeight", 1000);

/******************************************************************************
 * LOGGING (for debugging)
 ******************************************************************************/

// Only log to console, not to network
defaultPref("browser.console.showInPanel", true);

// Disable crash annotations that might leak info
lockPref("toolkit.crashreporter.includePingInCrashReport", false);

/******************************************************************************
 * END OF CONFIGURATION
 ******************************************************************************/

// Log successful config load
console.log("AnonNet Browser: Locked configuration loaded successfully");
console.log("AnonNet Browser: Proxy configured for 127.0.0.1:9050 (SOCKS5)");
console.log("AnonNet Browser: All security settings locked");
